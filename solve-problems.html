<!DOCTYPE html>
<html lang="ko">

<head>
    <script src="https://kit.fontawesome.com/cf112bfab0.js" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문제 풀이</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background-color: #333;
            color: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }

        .sidebar a {
            color: #ccc;
            text-decoration: none;
            margin: 10px 0;
            display: block;
            padding: 8px;
            border-radius: 4px;
        }

        .sidebar a:hover {
            color: #fff;
            background-color: #444;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #333;
        }

        /* Search Box */
        .search-box {
            width: 100%;
            max-width: 700px;
            margin-bottom: 20px;
            display: flex;
        }

        .search-box input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .search-box button {
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            background-color: #969393;
            color: white;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-box button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            transition: transform 0.2s;
        }

        /* Problem Set List */
        .problem-set-list {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .problem-set-list h3 {
            margin-bottom: 15px;
            color: #444;
            text-align: center;
        }

        .problem-set-list ul {
            list-style: none;
            padding: 0;
        }

        .problem-set-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .problem-set-list li:hover {
            background-color: #f0f0f0;
        }

        /* Problem Solving Section */
        .problem-solving {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .problem-solving h3 {
            margin-bottom: 15px;
            color: #444;
        }

        .problem-description {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #555;
            text-align: center;
        }

        .answer-input {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 15px;
            height: 100px;
        }

        .buttons {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .buttons button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            flex: 1;
            margin: 0 5px;
        }

        .submit-btn {
            background-color: #28a745;
        }

        .submit-btn:hover {
            background-color: #218838;
        }

        .next-btn {
            background-color: #007bff;
            display: none;
        }

        .next-btn:hover {
            background-color: #0056b3;
        }

        /* Final Result */
        .final-result {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: none;
            text-align: center;
        }

        .final-result h3 {
            margin-bottom: 15px;
            color: #444;
        }

        .final-result p {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }

        .final-result button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #ffc107;
            color: white;
            transition: background-color 0.2s;
        }

        .final-result button:hover {
            background-color: #e0a800;
        }

        /* Back Link */
        .back-link {
            display: block;
            margin-top: 20px;
            text-align: center;
            color: #007bff;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Quich!</h2>
        <a href="create-problems.html">문제 출제</a>
        <a href="solve-problems.html">문제 풀이</a>
        <a href="search.html">정답 검색</a>
        <a href="ranking.html">유저 랭킹</a>
        <a href="info.html">설정</a>
        <a href="index.html">로그아웃</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">문제 풀이</div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" id="search-input" placeholder="푸실 문제 묶음 제목 또는 문제 내용을 검색하세요.">
            <button class="search-btn" id="search-btn">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>

        <!-- Problem Set List -->
        <div class="problem-set-list" id="problem-set-list-container">
            <h3>문제 묶음 목록</h3>
            <ul id="problem-set-list">
                <!-- 문제 묶음 목록이 여기에 동적으로 추가됩니다 -->
            </ul>
        </div>

        <!-- Problem Solving Section -->
        <div class="problem-solving" id="problem-solving-container">
            <h3 id="problem-title">문제 제목</h3>
            <p class="problem-description" id="problem-description">문제가 여기에 표시됩니다.</p>
            <textarea id="answer-input" class="answer-input" placeholder="답안을 입력하세요..."></textarea>
            <div class="buttons">
                <button class="submit-btn" id="submit-answer-btn">제출</button>
                <button class="next-btn" id="next-problem-btn">다음 문제</button>
            </div>
            <a href="solve-problems.html" class="back-link">뒤로</a>
        </div>

        <!-- Final Result -->
        <div class="final-result" id="final-result">
            <h3>문제를 모두 풀었습니다!</h3>
            <p id="score-summary">점수: 0 / 0</p>
            <button onclick="restartProblemSolving()">다시 시작하기</button>
            <a href="solve-problems.html" class="back-link">뒤로</a>
        </div>
    </div>

    <script>
        // 문제 세트를 로컬스토리지에서 가져오기
        function getProblemSetsFromLocalStorage() {
            const storedSets = localStorage.getItem("problemSets");
            return storedSets ? JSON.parse(storedSets) : [];
        }

        // 문제 풀이 기록 데이터 가져오기
        function getProblemsData() {
            const problemsData = localStorage.getItem("problemsData");
            return problemsData ? JSON.parse(problemsData) : [];
        }

        // 현재 로그인한 유저 가져오기
        const currentUser = localStorage.getItem("currentUser");

        // HTML 요소 참조
        const problemSetListContainer = document.getElementById("problem-set-list-container");
        const problemSetList = document.getElementById("problem-set-list");
        const searchBtn = document.getElementById("search-btn");
        const searchInput = document.getElementById("search-input");
        const problemSolvingContainer = document.getElementById("problem-solving-container");
        const problemTitle = document.getElementById("problem-title");
        const problemDescription = document.getElementById("problem-description");
        const answerInput = document.getElementById("answer-input");
        const submitAnswerBtn = document.getElementById("submit-answer-btn");
        const nextProblemBtn = document.getElementById("next-problem-btn");
        const finalResult = document.getElementById("final-result");
        const scoreSummary = document.getElementById("score-summary");

        // 문제 목록 및 순서 초기화
        let selectedProblemSet = "";
        let problems = [];
        let currentProblemIndex = 0;
        let userAnswers = [];

        // 문제 세트 목록 표시 함수
        function displayProblemSets(filteredSets = null) {
            console.log("Displaying problem sets");
            problemSetList.innerHTML = "";
            problemSetListContainer.style.display = "block";
            problemSolvingContainer.style.display = "none";
            finalResult.style.display = "none";

            const problemSets = filteredSets || getProblemSetsFromLocalStorage();
            console.log("Problem Sets:", problemSets);

            if (problemSets.length === 0) {
                problemSetList.innerHTML = "<li>등록된 문제 묶음이 없습니다.</li>";
                return;
            }

            problemSets.forEach(set => {
                const listItem = document.createElement("li");
                listItem.textContent = set.title;
                listItem.setAttribute('data-set-title', set.title);

                // 클릭 이벤트: 문제 묶음을 클릭하면 해당 묶음의 문제 목록 표시
                listItem.addEventListener("click", () => {
                    console.log("Selected Problem Set:", set.title);
                    selectProblemSet(set.title);
                });

                problemSetList.appendChild(listItem);
            });
        }

        // 문제 묶음 선택 함수
        function selectProblemSet(setTitle) {
            selectedProblemSet = setTitle;
            problems = getProblemsFromSet(setTitle);
            console.log("Problems in Set:", problems);
            if (problems.length === 0) {
                alert("선택한 문제 묶음에 문제가 없습니다.");
                return;
            }
            currentProblemIndex = 0;
            userAnswers = [];
            loadProblem();
            problemSetListContainer.style.display = "none";
            problemSolvingContainer.style.display = "flex";
            finalResult.style.display = "none";
        }

        // 특정 문제 묶음의 문제 목록 가져오기
        function getProblemsFromSet(problemSetTitle) {
            const problemSets = getProblemSetsFromLocalStorage();
            const selectedSet = problemSets.find(set => set.title === problemSetTitle);
            return selectedSet ? selectedSet.problems : [];
        }

        // 문제 로드 함수
        function loadProblem() {
            if (currentProblemIndex < problems.length) {
                const problem = problems[currentProblemIndex];
                problemTitle.textContent = `문제 ${problem.id}`;
                problemDescription.textContent = problem.description;
                answerInput.style.display = "block";
                submitAnswerBtn.style.display = "inline-block";
                nextProblemBtn.style.display = "none";
                answerInput.value = "";
                answerInput.focus(); // 자동 포커스
                console.log(`Loaded Problem ${problem.id}`);
            } else {
                showFinalResult();
            }
        }

        // 정답 제출 함수
        function submitAnswer() {
            if (currentProblemIndex < problems.length) {
                const userAnswer = answerInput.value.trim();
                const problem = problems[currentProblemIndex];
                const isCorrect = userAnswer === problem.answer;

                console.log(`Submitted Answer for Problem ${problem.id}: ${userAnswer} (Correct: ${isCorrect})`);

                if (userAnswer === "") {
                    alert("답안을 입력해주세요.");
                    return;
                }

                // 문제 풀이 기록 저장
                if (currentUser) {
                    const problemsData = getProblemsData();
                    problemsData.push({ username: currentUser, problemSet: selectedProblemSet, problemId: problem.id, isCorrect });
                    localStorage.setItem("problemsData", JSON.stringify(problemsData));
                }

                userAnswers.push(isCorrect);
                currentProblemIndex++;
                if (currentProblemIndex < problems.length) {
                    loadProblem();
                } else {
                    showFinalResult();
                }
            }
        }

        // 최종 결과 표시 함수
        function showFinalResult() {
            const correctCount = userAnswers.filter(answer => answer).length;

            problemTitle.textContent = "문제를 모두 풀었습니다!";
            problemDescription.textContent = `총 ${problems.length}문제 중 ${correctCount}문제를 맞췄습니다.`;
            answerInput.style.display = "none";
            submitAnswerBtn.style.display = "none";
            nextProblemBtn.textContent = "다시 시작하기";
            nextProblemBtn.style.display = "inline-block";

            scoreSummary.textContent = `점수: ${correctCount} / ${problems.length}`;

            // 다음 문제 버튼을 다시 시작 버튼으로 기능 변경
            nextProblemBtn.onclick = restartProblemSolving;
        }

        // 문제 풀이 초기화 함수
        function restartProblemSolving() {
            currentProblemIndex = 0;
            userAnswers = [];
            loadProblem();
            finalResult.style.display = "none";
        }

        // 문제 묶음 검색 기능
        function searchProblemSets(query) {
            console.log("Searching for:", query);
            const allSets = getProblemSetsFromLocalStorage();
            const filteredSets = allSets.filter(set =>
                set.title.toLowerCase().includes(query.toLowerCase()) ||
                set.problems.some(problem =>
                    problem.id.toString().includes(query) ||
                    problem.description.toLowerCase().includes(query.toLowerCase())
                )
            );
            console.log("Filtered Sets:", filteredSets);
            if (filteredSets.length === 0) {
                alert("검색 결과가 없습니다.");
            }
            displayProblemSets(filteredSets);
        }

        // 문제 묶음 검색 버튼 클릭 이벤트
        searchBtn.addEventListener("click", () => {
            const query = searchInput.value.trim();
            if (query === "") {
                displayProblemSets();
                return;
            }
            searchProblemSets(query);
        });

        // 엔터 키로 검색 가능하게 설정
        searchInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                searchBtn.click();
            }
        });

        // 샘플 문제 세트 추가 함수
        function addSampleProblemSets() {
            const sampleProblemSets = [
                {
                    title: "더하기 문제",
                    creator: "system", // 시스템이 생성한 문제 묶음
                    problems: [
                        { id: 1, description: "1 + 1은?", answer: "2" },
                        { id: 2, description: "2 + 3은?", answer: "5" },
                        { id: 3, description: "10 + 15는?", answer: "25" }
                    ]
                },
                {
                    title: "빼기 문제",
                    creator: "system",
                    problems: [
                        { id: 4, description: "5 - 3은?", answer: "2" },
                        { id: 5, description: "10 - 7은?", answer: "3" },
                        { id: 6, description: "20 - 5는?", answer: "15" }
                    ]
                },
                {
                    title: "곱하기 문제",
                    creator: "system",
                    problems: [
                        { id: 7, description: "3 * 4은?", answer: "12" },
                        { id: 8, description: "5 * 6은?", answer: "30" },
                        { id: 9, description: "7 * 8은?", answer: "56" }
                    ]
                },
                {
                    title: "나누기 문제",
                    creator: "system",
                    problems: [
                        { id: 10, description: "10 / 2는?", answer: "5" },
                        { id: 11, description: "20 / 4는?", answer: "5" },
                        { id: 12, description: "30 / 5는?", answer: "6" }
                    ]
                }
            ];

            localStorage.setItem("problemSets", JSON.stringify(sampleProblemSets));
            alert("샘플 문제 세트가 추가되었습니다!");
            displayProblemSets(sampleProblemSets);
        }

        // 페이지 로드 시 문제 세트 목록 표시 및 샘플 데이터 추가
        window.onload = function () {
            let problemSets = JSON.parse(localStorage.getItem("problemSets")) || [];
            if (problemSets.length === 0) {
                // 샘플 문제 세트 추가
                addSampleProblemSets();
            } else {
                displayProblemSets();
            }
        };

        // 제출 버튼에 이벤트 리스너 연결
        submitAnswerBtn.addEventListener("click", submitAnswer);
    </script>
</body>

</html>
